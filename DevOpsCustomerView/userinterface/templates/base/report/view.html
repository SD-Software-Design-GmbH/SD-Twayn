{% extends base %}
{% load i18n %}
{% load static %}
{% load dates %}
{% load template %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'vendor/frappe-gantt/frappe-gantt.min.css' %}">
  <script nonce="{{ request.csp_nonce }}" src="{% static 'vendor/frappe-gantt/frappe-gantt.js' %}"></script>
{% endblock %}

{% block content %}
  <h2>{% trans "Project status" %}</h2>
  <table class="table">
    <tr>
      <th>{% trans "Name" %}</th>
      <th class="text-center">{% trans "Last activity" %}</th>
      <th class="text-center">{% trans "Active state" %}</th>
      <th class="text-center">{% trans "Active milestone" %}</th>
    </tr>
    {% for project in activeProjects %}
      <tr>
        <td><strong>{{ project.localProject.name }}</strong><br>{% trans "Last activity:" %} <em>{{ project.mostRecentIssues.0.updated_at|parse_iso }}</em></td>
        <td class="text-center">
          {% with dsince=project.mostRecentIssues.0.updated_at|parse_iso|dayssince %}
          {% if dsince > 14 %}
              <i class="fa far fa-engine-warning" style="color: red;"></i>
            {% else %}
              <i class="fa far fa-thumbs-up" style="color: green;"></i>
            {% endif %}
            <br><small class="text-muted">{{ dsince }} {% trans "days ago" %}</small>
          {% endwith %}
        </td>
        <td class="text-center">
          {% if not project.localProject.inactive %}
            {% if project.remoteProject.open_issues_count == 0 %}
              <i class="fa far fa-engine-warning" style="color: red;"></i>
              <br><small class="text-muted">{% trans "active" %} + {% trans "without open issues" %}</small>
            {% else %}
              <i class="fa far fa-thumbs-up" style="color: green;"></i>
              <br><small class="text-muted">{% trans "active" %} + {{ project.remoteProject.open_issues_count }} {% trans "open issue(s)" %}</small>
            {% endif %}
          {% else %}
            {% if project.remoteProject.open_issues_count != 0 %}
              <i class="fa far fa-thumbs-up" style="color: green;"></i>
              <br><small class="text-muted">{% trans "inactive" %} + {% trans "without open issues" %}</small>
            {% else %}
              <i class="fa far fa-engine-warning" style="color: red;"></i>
              <br><small class="text-muted">{% trans "inactive" %} + {{ project.remoteProject.open_issues_count }} {% trans "open issue(s)" %}</small>
            {% endif %}
          {% endif %} 
        </td>
        <td class="text-center">
          <i class="fa far fa-thumbs-up" style="color: green;"></i>
        </td>
      </tr>
    {% endfor %}
  </table>
  <br>
  <h2>{% trans "Employees" %}</h2>
  <br>
  {% for member in members %}
    {% for project in member.getActiveProjects %}
      {% with gl=project.loadRemoteProject %}

        <script nonce="{{ request.csp_nonce }}">
          var tasks = [
          {% for milestone in allMilestones %} 
            
            {% if milestone.start_date and milestone.due_date %}
              {% with milestone.due_date|parse_date|dayssince as dayssince %}
                {% if milestone.expired == False or milestone.expired == True and dayssince < 365 %}
                {
                  id: '{{ milestone.id }}',
                  name: '{{ milestone.title }}',
                  start: '{{ milestone.start_date|parse_date|date:"Y-m-d" }}',
                  end: '{{ milestone.due_date|parse_date|date:"Y-m-d" }}',
                  progress: 0,
                },
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endfor %}
          ]
          var gantt = new Gantt(document.querySelector('#gantt{{ member.pk }}'), tasks, {
              header_height: 50,
              column_width: 30,
              step: 24,
              bar_height: 40,
              bar_corner_radius: 0,
              arrow_curve: 5,
              padding: 18,
              custom_popup_html: function(task) {
                window.location = '/project/{{ remoteProject.path }}/{{ remoteProject.id }}/milestone/'+task.id;
                return ``;
              },
              {% if daysbetween < 180 %}
                view_mode: 'Week',
              {% elif daysbetween < 730 %}
                view_mode: 'Month',
              {% else %}
                view_mode: 'Year',
              {% endif %}
              date_format: 'YYYY-MM-DD',
          });
        </script>
      {% endwith %}
    {% endfor %}
    <div class="row">
      <div class="col-1 text-center">
        <img src="{{ member.avatar.url }}" width="50" class="rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{{ assignee.name }}">
      </div>    
      <div class="col-7">
        <h4>{{ member.name }}</h4><br>
        <svg id="gantt{{ member.pk }}"></svg>
      </div>
      <div class="col-4">
        <h5>{% blocktranslate with projectCount=member.getActiveProjects|length %}In {{ projectCount }} active projects involved{% endblocktranslate %}:</h5>
        {% for project in member.getActiveProjects %}
          {% with gl=project.loadRemoteProject %}
            <a href="/project/{{ gl.remoteProject.path }}/{{ gl.remoteProject.id }}" class="nolink">
              <li class="list-group-item">
                  <strong>{{ project.name }}</strong><br>
                  <div class="text-muted">
                    {% for p in gl.activeMilestones %}
                      <small>{{ p.title }} <em>({{ p.start_date|parse_date|date:"d.m.y" }} - {{ p.due_date|parse_date|date:"d.m.y" }})</em></small><br>
                    {% endfor %}
                  </div>
              </li>
            </a>
          {% endwith %}
        {% endfor %}
      </div>
    </div>
    <hr>
  {% endfor %}
{% endblock %}